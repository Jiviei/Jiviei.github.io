---
order: 2
title: "@PS Кэширование файлов"
---

Читать большое количество файлов из OPFS дорого, поэтому нужно придумать способ не обращаться к OPFS такое большое количество раз.

У Emscripten есть реализация файловой системы memfs, которая хранит данные в памяти. Можно попробовать в экспериментальном формате использовать его для файлов, к которым требуется доступ “прям сейчас”.

## Хранение активного каталога в memfs

Когда пользователь заходит в какой-либо каталог, приложение пытается прочитать его из memfs и если ему не удаётся, читает всю директорию каталога и сохраняет в памяти. Дальнейшая работа происходит только с каталогом в памяти.

Нужно придумать, чтобы приложение по-умному могло жонглировать между файлами из OPFS и файлами из памяти. Чтобы изменения вовремя записывались в OPFS.

**Замеры**:

-  Скопировать каталог gramax-board из OPFS в память занимает **\~10-14s**, записать из памяти в OPFS столько же. Надо будет протестировать копирование в многопотоке. Но это реализовать кратно сложнее

-  Синхронизация -- самая долгая и частая операция -- \~**32s** в каталоге в OPFS, \~**2s** в memfs, ускорение **x16**. Изменений нет в обоих каталогах, пулл не требовался.

-  Заархивировать каталог в `tar` opfs -> opfs занимает **\~9s**. Но это всё равно не подходит: tar работает неважно в webassembly и к тому же нам всё ещё нужен доступ к файлам из opfs

**Проблемы**:

-  Как синхронизировать файлы, которые перезаписывает libgit2? С файлами, которые мы изменяем сами -- понятно

   -  **Решение**: Можно расставить коллбеки в коде emscripten, чтобы он вызывал наши функции. Думаю (но не знаю точно) это слинкуется нормально при компиляции. Тогда мы сможем знать где и какие файлы изменяются и можем быть в этом уверены. И при этом это не настолько сложно, как реализовывать свой бекенд.

      Плохо только одно - то что для компиляции придётся использовать патченый emscripten

   -  **Решение**: .git можно хранить в OPFS и копировать в память только workdir. Libgit2 умеет работать в рабочими директориями, которые находятся отдельно от .git. Это избавит от необходимости синхронизации файлов гита, что не убережёт от потери локальных изменений в случае ошибки, но сохранит репозиторий в целости

   -  **Решение**: самый простой и наивный вариант -- синхронизовать файлы путём тупого копирования и перезатирация memfs -> opfs. Эта операция долгая, но реализовать её несложно. Намного проще, чем вычислять, какой именно файл надо сохранить.

-  Закэширован будет только активный каталог, иначе у пользователя может не хватить ОЗУ. Тогда при частом смене каталогов приложению будет очень тяжело кэшировать. Читать в фоне, а пока не закешировался использовать из OPFS?

   Либо можно поступить точно также, как и каталогами: кэшировать при загрузке каталога без оглядки на количество. При перезагрузке страницы, смене воркспейса кэш очищается

## Использование большого блоба в качестве файловой системы

Засунуть кучу файлов в один большой файл не сложно ([либа](https://lib.rs/crates/cfb)). Это будет даже эффективнее для OPFS. Проблема заключается только в libgit2 - его не получится заставить читать оттуда. Только обходными путями -- что-то придумывать с emscripten. Реализовывать свой бекенд для файловой системы. Либо переопределять системные вызовы по типу `popen`/`write`/так далее. А это очень сложно, потому что ни публичного API, ни документации ещё нет

## Сохранение файлов в CFB file в OPFS в реальном времени

Основное взаимодействие будет происходить с memfs -- ни libgit2, ни приложение не будут знать, что работают с чем-то другим.

В это время в реализации memfs у emscripten будут добавлены несколько коллбеков (как из первого метода) и все действия с файловой системой будут дублироваться с большим файлом, который представляет собой файловую систему. При загрузке приложение состояние будет восстанавливаться оттуда.

При такой реализации этот баг может потерять актуальность: [GXS-1758](https://support.ics-it.ru/issue/GXS-1758) Не клонится каталог Sellout в Я.Браузере

**Проблемы**:

-  Как отображать главную страницу? Нам нужны все каталоги, а загружать их в память сразу - гиблое дело.

   -  **Решение**: Загружать файлы по запросу. На главной странице фаллбечить в OPFS, если в памяти файл не найден. А если пользователь уже находится в каталоге, то загружать его полностью