---
order: 14
title: "@PS @AL Версионирование"
properties:
  - name: Assignee
    value: PS
  - name: PO
    value: AL
  - name: Release
    value: october-24
  - name: Type
    value: Epic
  - name: State
    value: dev
---

## Проблема

Сейчас у пользователей есть возможность просматривать каталог только одной ревизии (версии) -- ветку, которую задал редактор. Возможности посмотреть на прошлые версии каталога у пользователей нет, но иногда она требуется: например, для ознакомления с документацией прошлой версии продукта.

Нужно, чтобы редактор мог указывать, какие ревизии каталога следует показывать пользователям,  пользователи -- могли просматривать и переключать их независимо от друг от друга.

## Примеры реализации

[Документация git](https://git-scm.com/docs). Каждая отдельная страница имеет свою историю версий, необходимо переключатся отдельно.

[Docosaurus](https://docusaurus.io/docs). Версия переключается для всего “каталога”, есть предупреждение, что пользователь находится на неактуальной версии. Версии хранятся в отдельных директориях, есть список доступных версий в json-файле

## Концепция

**Версия** -- git-тег, который редактор задаёт в `.doc-root.yaml`. На момент первого этапа это нельзя сделать из UI, только через git. Интерфейс создания и удаления тегов отлично бы вписался в граф коммитов.

Теги могут задаваться в виде regex, для того, чтобы редактор мог создавать множество тегов, не заморачиваясь постоянным добавлением их в `doc-root.yaml`. Пример:

```yaml
versions:
	- v1
	- v2
```

**(сделать glob-паттерн)**

**(всегда читать этот пропс с основной ветки)**

В докпортале пользователь имеет возможность просматривать либо последнюю ревизию каталога -- ветку, которую задал редактор, либо ревизию. При переключении ревизии, она переключается только для конкретного пользователя, никак не воздействуя на других.

Если пользователь находится не на актуальной ревизии, то докпортал информирует его об этом, а url страницы содержит ревизию

### Интерфейс переключения

Если каталог поддерживает версионирование, в правом углу, около переключателя языка, становится активным дропдаун с ревизиями. Актуальная ревизия отображается в виде названия ветки, а все остальные в виде тегов.

[image:./versioning.png:::0,3.26087,100,96.73913:]

Эта кнопка неактивна, если версионирование не было включено или не указан  ни один существующий тег.

[image:./versioning-2.png::Версионирование выключено:0,0,100,100:61:]

### Вариант 1: Переключение ревизии

У докпортала есть несколько рабочих директорий (workdir):

-  Основная рабочая директория -- та, что есть на сейчас, используется для отображения последней актуальной ревизии, создаётся при клонировании каталога

-  Рабочие директории с ревизиями -- создаются “on-demand”, когда какой-либо пользователь выбирает эту ревизию, далее -- хранятся в той же директории каталога в отдельных директориях

**Проблемы**:

-  Все проблемы рабочей директории -- чекаут и мерж, непонятно откуда взявшиеся изменения, необходимость пулла (который и сейчас достаточно тяжело даётся докпорталу в некоторых случаях), перемножаются на необходимость иметь несколько рабочих директорий, количество которых может очень резко расти

-  При переключении на ревизию впервые, пользователю придётся подождать, пока git зачекаутит новую рабочую директорию. Впрочем, это не должно занимать много времени

-  Если редактор захочет удалить ревизию и удалит для этого git-тег, на докпортале останется рабочая директория с этой ревизией

### Вариант 2: Чтение файлов напрямую из .git вместо переключения ревизий

Докпортал может работать с bare-репозиториями, который представляют собой одну лишь директорию .git. Это не breaking change, поскольку докпортал сможет продолжить работать с уже склонированными репозиториями.

При помощи такого способа не будет необходимости иметь рабочую директорию и каталоги докпортала станут read-only фундаментально. Вместо рабочей директории, каталог будет парситься из файлового дерева коммита.

{% table %}

---

*  {% colwidth=[419] isHeader=true %}

   Тест скорости чтения

*  {% colwidth=[213] isHeader=true %}

   fs

*  {% isHeader=true %}

   git

---

*  {% colwidth=[419] %}

   Рекурсивное чтение всех файлов `gramax-board`

*  {% colwidth=[213] %}

   400ms  ±100ms

*  1000ms ±300ms

{% /table %}

Эта разница в скорости не сильно влияет на общую производительность, поскольку докпорталу не требуется читать каталог каждый раз -- он кэширует распаршенные статьи.

Сложности может составить интеграция этого фунционала в приложение. Но сомневаюсь, что реализовать первый вариант сильно проще.

## Вопросы

1. Как лучше хранить текущую ревизию в урле? Вместо ветки -- название тега? Что делать в случае коллизии названия ветки и тега? Или лучше хранить OID -- но тега или коммита, на который он указывает?

   1. Если хранить OID коммита, то в случае второго варианта ревизий, это будет выглядеть более “нативно“. Можно будет посмотреть любой коммит, точно так же как и запретить это делать. Наверняка в будущем понадобится такой функционал

---

1. Сабмодули -- отказываемся

2. От текущей ветки избавиться, нужно указывать конкретные версии

3. Заменить теги на рефы (ветки/теги)

4. Надо решить как конфигурировать версии и их порядок, как их называть

   1. Как их локализовать? А надо ли?

5. Сделать интерфейс для управления версионированием



1. Перетащить выбор версии и язык контента в действия над каталогом

2. Добавить выбор языка ui на прежнее место